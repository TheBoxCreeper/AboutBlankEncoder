<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>New Tab</title>
    <link rel="shortcut icon" href="favicons/!Encoder Icon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="config.js" ></script>
    <script id='constructor'>
    console.log(config);
    const urlSchemes = ['https://','file://','http://','data:','chrome-extension://']
    let setScheme;
    const cssString = "body {font-family:".concat(config[4].value,"} :root{ --base-color: ",config[0].value,"; --primary-color: ",config[1].value,"; --secondary-color: ",config[2].value,"; --disabled-color: ",config[3].value,"; }");
    const themeCss = document.createElement('style');
    themeCss.textContent = cssString;
    document.head.appendChild(themeCss);
    const baseCss = document.createElement('link');
    baseCss.setAttribute('rel','stylesheet');
    baseCss.setAttribute('href','css/base.css');
    document.head.appendChild(baseCss);
	if (config[5].value !== 'none') {
	  if (urlSchemes.includes(config[5].value)) {
		setScheme = config[5].value;
		} else {
		setScheme = 'http://';
		};
	};
    </script>
    <link rel="stylesheet" href="css/zipnotif.css" />
    <link rel="stylesheet" href="css/newtab.css" />
    <link rel="stylesheet" href="font.css" />
  </head>
  <body style="margin: 0px; height: 100vh;">
    <div id="version" data-version="10"></div>
    <div id="NewTab" style="display: none;height:100vh; background-image: url(NewTabPage/Background.png); background-repeat: no-repeat; background-size: cover; background-attachment: fixed;">
      <iframe title= 'Bar' style=" z-index: -1;border:none; margin-left: auto; margin-right: 0; width: 100%; height: 64px" src="bar.html"></iframe>
      <img width="272px" height="92px" id="Logo" alt="" src="NewTabPage/GoogleLogo.png">
      <div id="inputWrapper">
        <input placeholder="Search Google or type a URL" id="SearchArea" class="searchBox">
        <script>
	  const searchBox = document.getElementById("SearchArea");
          searchBox.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && config[8].value) {
              const text = `https://google.com/search?q=${encodeURIComponent(searchBox.value)}`
              window.location.href = text;
            };
          });
	</script>
      </div>
    </div>
    <div id="bodyDiv" class="bodyDiv" style="margin-left: 8px; margin-right:8px; z-index:10;">
      <h1 class="title">About:Blank Encoder by <a id="TitleLink" href="https://google.com">Terminal</a>
      </h1>
      <p >Encode any url into a about:blank page! Note: Some websites do not allow this. You can get any version of this encoder here: <a id = "drive" href="https://google.com">Versions</a>. </p>
      <p id="currentTime" ></p>
      <p id="currentConnection" style=" color:var(--primary-color)">Determining Online Connection</p>
      <p id="versionCounter" >Version: Determining Version</p>
      <button type='button' class="c-button"id="update" disabled >Update</button>
      <br>
      <p class="ZipNotif" style="color: #ff0000">The encoder has been installed improperly! This can be caused by being in a zipped folder, causing limited features, or it could be caused by a broken installation. Download the latest one here: <a id='zipLink' href='https://google.com'>Latest Version</a>.</p>
      <label for="URLInput" >Put your url below! (Required)</label>
      <br>
      <input class="TextInput" id="URLInput" type="text" placeholder="URL">
      <br>
      <label for="TitleInput" >Put the title of the page below! You should use the appropiate title for the icon (Optional)</label>
      <br>
      <input class="TextInput" id="TitleInput" type="text" placeholder="about:blank">
      <br>
      <label for="upload"  id="ImageLabel">Upload the icon below. Choose an appropiate icon for the title. Icons are available in the favicon folder (Optional)</label>
      <br>
      <br>
      <button type="button" class="c-button c-width" id="UploadButton">Upload Image for Icon (Optional)</button>
      <input type="file" accept="image/*" id="upload" class="FileInput">
      <p id="UploadText">Image Chosen: No Image Chosen</p>
      <img id="DisplayImage" src="#" alt="Image Chosen">
      <br>
      <label for="RuffleBox" class="hiddencheckbox">Use Ruffle scripts for Flash Games. <input type="checkbox" id="RuffleBox">
        <span class="Cbox"></span>
      </label>
      <label for="BCodeBox" id = 'bodyLabel' style = 'display:none;' class="hiddencheckbox">Encode HTML code in the body instead of an URL. This can be used if you want to use an iframe insted of an embed. <input type="checkbox" id="BCodeBox">
        <span class="Cbox"></span>
      </label>
      <label for="WarnBox" class="hiddencheckbox">Display a warning on when the tab is closed. <input type="checkbox" id="WarnBox">
        <span class="Cbox"></span>
      </label>
      <label for="DynamicBox" class="hiddencheckbox">Use Dynamic Tabs for URLs. <input type="checkbox" id="DynamicBox">
        <span id="DynamicBoxSpan" class="Cbox"></span>
      </label>
      <label for="PopupBox" class="hiddencheckbox">Open tab as popup (New window). <input type="checkbox" id="PopupBox">
        <span class="Cbox"></span>
      </label>
      <br>
      <div id='htmlCode' style='display:none;'>
      <label for="HeadCode" >Insert Head HTML code here! (Optional)</label>
      <br>
      <textarea class="TextInput" id="HeadCode" type="text" placeholder="Your code here..."></textarea>
      <br>
      <label for="BodyCode" >Insert Body HTML code here! (Optional)</label>
      <br>
      <textarea disabled class="TextInput" id="BodyCode" type="text" placeholder="Your code here..."></textarea>
      <br>
      </div>
      <button type="button" id="LinkButton" class="c-button c-width">Open link in about:blank!</button>
      <h1 class="title">View embeddable links below:</h1>
      <p id="OfflineBox" style="visibility: hidden; color: #ff0000">You cannot embed website urls without internet. Doing so will show an error page.</p>
      <iframe title='Link list' id="UrlRef" width="100%" height="500px" style="border:none" scrolling="no" src="https://google.com"></iframe>
      <script>
        const urlObj = new window.URL(window.location.href);
        const URLInput2 = document.getElementById("URLInput2");
        const URLInput = document.getElementById("URLInput");
        let win;
        let NewTabState;
        const NewTabFrame = document.getElementById('NewTab');
        const BodyDiv = document.getElementById('bodyDiv');
        const HeadHtml = document.getElementById('HeadCode');
        const BodyHtml = document.getElementById('BodyCode');
        const UploadButton = document.getElementById('UploadButton');
        const Upload = document.getElementById('upload');
        const BodySwitch = document.getElementById('BCodeBox');
        const UploadTitle = document.getElementById('TitleInput');
        const UploadText = document.getElementById('UploadText');
        const UploadedIcon = document.getElementById('DisplayImage');
        const OnlineSViewer = document.getElementById('currentConnection');
        const UrlRef = document.getElementById('UrlRef');
        const OfflineBox = document.getElementById('OfflineBox');
        const DynamicBox = document.getElementById('DynamicBox');
	const PopupBox = document.getElementById('PopupBox');
        const DynamicBoxSpan = document.getElementById('DynamicBoxSpan');
        let iconURL;
        let internet = false;
	//Finish Declarations
        function checkConnection() {
          if (navigator.onLine) {
            internet = true;
            OnlineSViewer.style.color = "var(--primary-color)";
            OnlineSViewer.textContent = "You are online!";
            UrlRef.style.visibility = 'visible';
            OfflineBox.style.visibility = 'hidden';
	    return internet;
          } else {
            internet = false;
            OnlineSViewer.style.color = "#ff0000";
            OnlineSViewer.textContent = "You are offline!";
            OfflineBox.style.visibility = 'visible';
            UrlRef.style.visibility = 'hidden';
	    return internet;
          };
          return internet;
        };
        window.addEventListener('load', checkConnection);
        window.addEventListener('online', checkConnection);
        window.addEventListener('offline', checkConnection);
        window.addEventListener('keydown', function(event) {
          if (event.ctrlKey && event.key === '\\') {
            console.log('Keyswitch detected')
            if (NewTabState) {
              NewTabState = false;
              NewTabFrame.style.display = 'none';
              BodyDiv.style.display = 'block';
              console.log('NewTabState1 is ', NewTabState);
            } else {
              NewTabState = true
              NewTabFrame.style.display = 'block';
              BodyDiv.style.display = 'none';
              console.log('NewTabState2 is ', NewTabState);
            };
          };
        });
        Upload.addEventListener('change', function() {
          UploadText.textContent = "Image Chosen: " + this.files[0].name
        })
        UploadButton.onclick = function() {
          document.getElementById('upload').click();
        };
        BodySwitch.addEventListener('change', (event) => {
          EncodeBody();
        });
        function EncodeBody() {
          if (BodySwitch.checked) {
            URLInput.setAttribute("disabled", "true");
            DynamicBox.setAttribute("disabled", "true");
            DynamicBox.checked = false;
            DynamicBoxSpan.className = 'Cbox disabled';
            BodyHtml.removeAttribute("disabled");
          } else {
            URLInput.removeAttribute("disabled");
            DynamicBox.setAttribute("disabled", "true");
            DynamicBoxSpan.className = 'Cbox disabled';
            BodyHtml.setAttribute("disabled", "true");
          };

        };
        Upload.addEventListener('change', (event) => {
          const icon = event.target.files[0];
        });
        function showTime() {
          document.getElementById('currentTime').innerHTML = new Date().toUTCString();
        };
        showTime();
        setInterval(function() {
          showTime();
        }, 1000);
        Upload.onchange = evt => {
           const [file] = Upload.files;
          if (file) {
            iconURL = URL.createObjectURL(file);
            UploadedIcon.src = iconURL;
            return iconURL;
          };

        };
        document.querySelector('#LinkButton').onclick = function() {
	function checkString(str, substrs) {
  		return substrs.some(substr => str.startsWith(substr));
	};
	let url = URLInput.value;
	if (!checkString(url,urlSchemes) &&  !(config[5].value === 'none')) {
	url = setScheme.concat(url);
	};
	  if (PopupBox.checked) {
	    win = window.open('','_blank','width=600;height=400');  
	  } else {
	    win = window.open();  
	  };
          win.document.body.style.margin = '0';
          win.document.body.style.height = '100vh';
          win.document.head.innerHTML = HeadHtml.value;
	  const charset = win.document.createElement('meta');
	  charset.setAttribute('charset','UTF-8');
	  win.document.head.appendChild(charset);
	  let embed;
          const embed2 = win.document.createElement('embed');
	  if (DynamicBox.checked) {
	    embed = win.document.createElement('iframe');
            embed.style.height = 'calc(100vh - 42px)';
	    embed2.style.height = 'calc(100vh - 42px)';
          } else {
	    embed = win.document.createElement('embed');
            embed.style.height = '100vh';
	    embed2.style.height = '100vh';
          };
          embed.style.border = 'none';
          embed.style.width = '100%';
          embed.style.margin = '0';
          embed.id = 'Embed';
          embed.src = url;
          embed2.style.border = 'none';
          embed2.style.width = '100%';
          embed2.style.margin = '0';
          embed2.id = 'Embed2';
          embed2.src = "https://cache.armorgames.com/files/games/awesome-tanks-12812.swf"
          embed2.style.display = 'none'
          const icon = win.document.createElement('link');
          icon.rel = "shortcut icon";
          icon.id = "PageIcon";
          icon.href = iconURL;
          win.document.head.appendChild(icon);
          const title = win.document.createElement('title');
          title.id = "PageTitle"
          title.textContent = UploadTitle.value;
          win.document.head.appendChild(title);
          if (document.getElementById('RuffleBox').checked) {
            const Ruffle = win.document.createElement('script');
            Ruffle.src = "https://unpkg.com/@ruffle-rs/ruffle";
            win.document.head.appendChild(Ruffle);
          };
          if (DynamicBox.checked) {
	    const Ruffle2 = win.document.createElement('script');
            Ruffle2.src = "https://unpkg.com/@ruffle-rs/ruffle";
            win.document.head.appendChild(Ruffle2);
            const themeCss = win.document.createElement('style');
            themeCss.rel = "stylesheet";
            themeCss.textContent = cssString;
            win.document.head.appendChild(themeCss);
            const terminalstyle = win.document.createElement('link');
            terminalstyle.rel = "stylesheet";
            terminalstyle.href = "css/base.css";
            win.document.head.appendChild(terminalstyle);
            const fontstyle = win.document.createElement('link');
            fontstyle.rel = "stylesheet";
            fontstyle.href = "font.css";
            win.document.head.appendChild(fontstyle);
            const cfscript = win.document.createElement('script');
            cfscript.src = "DynamicTab/dynamictab.js"
            win.document.body.appendChild(cfscript)
            const ctrlFrame = win.document.createElement('div');
            ctrlFrame.id = 'ctrlFrame';
            const ctrlFrameParts = win.document.createElement('div');
            ctrlFrameParts.id = 'ctrlFrameParts';
            ctrlFrameParts.style.height = 'calc(100vh - 105px)';
            ctrlFrameParts.style.display = 'none';
            ctrlFrameParts.style.marginTop = '33px';
            ctrlFrameParts.style.marginRight = '33px';
            ctrlFrameParts.style.marginLeft = '33px';
            const texttitle = win.document.createElement('p');
            texttitle.className = 'title';
            texttitle.innerHTML = 'About:Blank Dynamic Tab by '
            const tturl = win.document.createElement('a');
            tturl.setAttribute("href",document.getElementById("TitleLink").getAttribute("href"));
            tturl.textContent = "Terminal";
            texttitle.appendChild(tturl);
            ctrlFrameParts.appendChild(texttitle);
            const UrlLabel = win.document.createElement('label');
            UrlLabel.setAttribute('for', 'UrlInput');
            UrlLabel.textContent = 'Tab Url';
            ctrlFrameParts.appendChild(UrlLabel);
            const UrlTabInput = win.document.createElement('input');
            UrlTabInput.setAttribute('type', 'text');
            UrlTabInput.className = 'TextInput';
            UrlTabInput.id = 'UrlInput';
            UrlTabInput.setAttribute('value', url);
            ctrlFrameParts.appendChild(UrlTabInput);
            const TitleLabel = win.document.createElement('label');
            TitleLabel.setAttribute('for', 'TitleInput');
            TitleLabel.textContent = 'Tab Title';
            ctrlFrameParts.appendChild(TitleLabel);
            const TitleInput = win.document.createElement('input');
            TitleInput.setAttribute('type', 'text');
            TitleInput.className = 'TextInput';
            TitleInput.id = 'TitleInput';
            TitleInput.setAttribute('value', document.getElementById("TitleInput").value);
            ctrlFrameParts.appendChild(TitleInput);
            const ImageLabel = win.document.createElement('label');
            ImageLabel.setAttribute('for', 'upload');
            ImageLabel.textContent = 'Tab Icon';
            ctrlFrameParts.appendChild(ImageLabel);
            const break1 = win.document.createElement('br');
            ctrlFrameParts.appendChild(break1);
            const break2 = win.document.createElement('br');
            ctrlFrameParts.appendChild(break2);
            const uploadTabButton = win.document.createElement('button');
            uploadTabButton.setAttribute('type', 'button');
            uploadTabButton.id = 'UploadButton';
            uploadTabButton.className = 'c-button c-width';
            uploadTabButton.textContent = 'Upload Image for Icon';
            ctrlFrameParts.appendChild(uploadTabButton);
            const uploadIcon = win.document.createElement('input');
            uploadIcon.setAttribute('type', 'file');
            uploadIcon.id = 'upload';
            uploadIcon.className = 'FileInput';
            uploadIcon.setAttribute('accept', 'image/*');
            ctrlFrameParts.appendChild(uploadIcon);
            const UploadTabText = win.document.createElement('p');
            UploadTabText.id = 'UploadText';
            UploadTabText.textContent = 'Tab Icon: Unchanged';
            ctrlFrameParts.appendChild(UploadTabText);
            const DisplayIcon = win.document.createElement('img');
            DisplayIcon.id = 'DisplayImage';
            DisplayIcon.setAttribute('alt', 'Image Chosen')
            DisplayIcon.src = iconURL;
            ctrlFrameParts.appendChild(DisplayIcon);
	    const break3 = win.document.createElement('br');
	    ctrlFrameParts.appendChild(break3);
	    const ruffleLabel = win.document.createElement('label');
	    ruffleLabel.setAttribute('for','RuffleBox');
	    ruffleLabel.className = 'hiddencheckbox';
	    ruffleLabel.textContent = 'Use Ruffle scripts for Flash Games.';
	    const ruffleCheck = win.document.createElement('input');
	    ruffleCheck.setAttribute('type','checkbox');
	    ruffleCheck.id = 'RuffleBox';
	    ruffleLabel.appendChild(ruffleCheck);
	    const ruffleFC = win.document.createElement('span');
	    ruffleFC.className = 'Cbox';
	    ruffleLabel.appendChild(ruffleFC);
	    ctrlFrameParts.appendChild(ruffleLabel);
	    const deleteBox = win.document.createElement('div');
	    deleteBox.style.display = 'flex';
	    deleteBox.style.justifyContent = 'center';
	    const deleteButton = win.document.createElement('button');
            deleteButton.className = 'c-button';
	    deleteButton.setAttribute('onclick','deleteFrame();');
	    deleteButton.textContent = 'Disable Dynamic Tabs';
	    deleteButton.style.backgroundColor = '#FF0000';
	    deleteButton.style.color =  '#000000';
            deleteBox.appendChild(deleteButton)
	    ctrlFrameParts.appendChild(deleteBox);
            //ctrlFrameParts end
            ctrlFrame.appendChild(ctrlFrameParts);
            const arrowbtn = win.document.createElement('button');
            arrowbtn.id = 'arrow'
            arrowbtn.setAttribute('onclick', 'cf();');
            arrowbtn.setAttribute('type', 'button');
            const arrowsym = win.document.createElement('i');
            arrowsym.id = "arrowsymholder"
            arrowsym.className = "arrowsym down"
            arrowbtn.appendChild(arrowsym);
            ctrlFrame.appendChild(arrowbtn);
            win.document.body.appendChild(ctrlFrame);
          };
          if (document.getElementById('WarnBox').checked) {
            const warn = win.document.createElement('script')
            warn.textContent = 'const beforeUnloadHandler = (event) => {event.preventDefault();event.returnValue = true; }; window.addEventListener(\"beforeunload\", beforeUnloadHandler);'
            win.document.head.appendChild(warn);
          };
          win.document.body.appendChild(embed);
	  win.document.body.appendChild(embed2);
          if (BodySwitch.checked) {
            win.document.body.innerHTML = BodyHtml.value;
          }; //Anything past this point in the script can be inserted in the body safely.
        };
      </script>
      <script id='secondary-constructor'>
	if (config[6].value) {
	UploadedIcon.src = config[6].value;
	iconURL = config[6].value;
	};
	UploadTitle.value = config[7].value;
	if (config[9].value) {
	document.getElementById('htmlCode').style.display = 'block';
	document.getElementById('bodyLabel').style.display = 'block';
	};
	</script>
      <script src="https://cdn.jsdelivr.net/gh/TheBoxCreeper/AboutBlankEncoder@master/or/update.js?t=<%= new Date().getTime() %>"></script>
    </div>
  </body>
</html>
